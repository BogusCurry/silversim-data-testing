<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"/>
	<meta name="apple-mobile-web-app-capable" content="yes"/>
	<title>SilverSim Admin</title>
	<!-- application stylesheet will go here -->
	<!-- dynamically apply native visual theme according to the browser user agent -->
	<script src="/admin/js/dojox/mobile/deviceTheme.js"></script>
	<!-- dojo configuration options -->
	<script>
		dojoConfig = {
			async: true,
			parseOnLoad: false
		};
	</script>
	<script src="/admin/js/dojo/dojo.js"></script>
	<script src="/admin/js/cryptojs/sha1.js"></script>
	<script>
		var sessionid = "";
		require([
			"dojox/mobile/parser",
			"dojox/mobile/compat",
			"dojox/mobile",
			"dijit/registry",
			"dojo/domReady!",
			"dojox/mobile/View",
			"dojox/mobile/Button",
			"dojox/mobile/Heading",
			"dojox/mobile/RoundRectList",
			"dojox/mobile/ListItem",
			"dojox/mobile/TransitionEvent",
			"dojox/mobile/TextBox",
			"dojox/mobile/Slider",
			"dojox/mobile/Switch",
			"dojox/mobile/Pane",
		], function (parser) {
			// now parse the page for widgets
			parser.parse();
		});
		

		function generateResponse(challenge, password)
		{
			return CryptoJS.SHA1(challenge + "+" + CryptoJS.SHA1(password)).toString();
		}
		
		function processLogin(e)
		{
			var username = user.value;
			var password = pass.value;
			require(["dojo/request","dojox/mobile/TransitionEvent","dijit/registry", "dojo/_base/array", "dojo/json"],
				function(request, TransitionEvent, registry, array)
				{
					request("/admin/json", 
					{
						method:"POST",
						data: JSON.stringify(
						{ 
							"method":"challenge",
							"user":username
						}),
						headers:
						{
							"Content-Type":"application/json"
						},
						handleAs:"json"
					}).then(
						function(challenge_data) 
						{
							if(!challenge_data.success)
							{
								alert("Login not possible. Code: "+ challenge_data.reason);
								return;
							}
							
							response = generateResponse(challenge_data.challenge, password);
							pass.value = "";
							user.value = "";
							sessionid = challenge_data.sessionid;
							
							request("/admin/json",
							{
								method:"POST",
								data: JSON.stringify(
								{
									"method":"login",
									"user":username,
									"response":response,
									"sessionid":challenge_data.sessionid
								}),
								headers:
								{
									"Content-Type":"application/json"
								},
								handleAs:"json"
							}).then(
								function(login_data) 
								{
									if(!login_data.success)
									{
										alert("Login failed: reason " + login_data.reason);
										return;
									}
									
									list = registry.byId("list_mainview");
									array.forEach(list.getChildren(),
									function(child)
									{
										list.removeChild(child);
										child.destroy();
									});
									
									var containsAdminAll = array.indexOf(login_data.rights, "admin.all") >= 0;
									var childWidget;
									
									if(containsAdminAll || array.indexOf(login_data.rights, "regions.control")>=0)
									{
										childWidget = new dojox.mobile.ListItem({
											clickable:true,
											label:"Region Start/Stop Control"});
										list.addChild(childWidget);
										childWidget.on("click", switchToRegionControl);
									}
									
									if(containsAdminAll || array.indexOf(login_data.rights, "regions.logincontrol")>=0)
									{
										childWidget = new dojox.mobile.ListItem({
											clickable:true,
											label:"Login Control"});
										list.addChild(childWidget);
										childWidget.on("click", switchToLoginControl);
									}
									
									/*
									if(containsAdminAll || array.indexOf(login_data.rights, "console.access")>=0)
									{
										//not yet working
										childWidget = new dojox.mobile.ListItem({
											clickable:true,
											label:"Sim Console",
											moveTo:"viewconsole",
											transition:"slide"});
										list.addChild(childWidget);
									}
									*/
									
									new TransitionEvent(viewlogin, {
										moveTo: "#viewmain",
										transition: "slide",
										transitionDir: 1
									}).dispatch();
								},
								function(err)
								{
								}
							);
						},
						function(err) {
						}
					);
				}
			);
		}
		
		function processLogout(e)
		{
			require(["dojo/request","dojox/mobile/TransitionEvent","dojo/json"],
				function(request, TransitionEvent)
				{
					request("/admin/json", 
					{
						method:"POST",
						data: JSON.stringify(
						{ 
							"method":"logout",
							"sessionid":sessionid
						}),
						headers:
						{
							"Content-Type":"application/json"
						},
						handleAs:"json"
					}).then(
						function(logout_data) 
						{
							if(!logout_data.success)
							{
								alert("Logout not possible. Code: "+ logout_data.reason);
							}
							new TransitionEvent(viewmain, {
								moveTo: "#viewlogin",
								transition: "slide",
								transitionDir: -1
							}).dispatch();
						},
						function(err) {
						}
					);
				}
			);
		}
	</script>
</head>
<body style="visibility:hidden;">
	<div id="viewlogin" data-dojo-type="dojox/mobile/View" data-dojo-props="selected:true">
		<h1 data-dojo-type="dojox/mobile/Heading">Login</h1>
		<ul data-dojo-type="dojox/mobile/RoundRectList">
		<li data-dojo-type="dojox/mobile/ListItem">Username
		<input data-dojo-type="dojox/mobile/TextBox" id="user" placeHolder="Username"/></li>
		<li data-dojo-type="dojox/mobile/ListItem">Password
		<input type="password" data-dojo-type="dojox/mobile/TextBox" id="pass" placeHolder="Password"/></li>
		<li data-dojo-type="dojox/mobile/ListItem"><button data-dojo-type="dojox/mobile/Button" data-dojo-props="onClick:function(e){processLogin(e)}">Login</button></li>
		</ul>
	</div>
	<div id="viewmain" data-dojo-type="dojox/mobile/View">
		<h1 data-dojo-type="dojox/mobile/Heading" data-dojo-props="label:'Admin'">
		<div id="viewmain_logout" data-dojo-type="dojox/mobile/ToolBarButton" 
						data-dojo-props="onClick: function(e){ processLogout(e); }, arrow: 'left', label: 'Logout'" style="float:left"></div>
				</h1>
		<ul id="list_mainview" data-dojo-type="dojox/mobile/RoundRectList">
		</ul>
	</div>
	<script>
		function startStopRegion(regionid, value)
		{
			var method = value == "on" ? "region.start" : "region.stop";
			
			require(["dojo/request"], function(request)
			{
				request("/admin/json", {
					method:"POST",
					data: JSON.stringify(
					{
						"method":method,
						"id":regionid,
						"sessionid":sessionid
					}),
					headers:
					{
						"Content-Type":"application/json"
					},
					handleAs:"json"
				}).then(
					function(regions_data) 
					{
						if(!regions_data.success)
						{
							if(regions_data.reason == 1)
							{
								new TransitionEvent(viewmain, {
									moveTo: "#viewlogin",
									transition: "slide",
									transitionDir: -1
								}).dispatch();
							}
							else
							{
								alert("Failed "+regions_data.reason);
							}
							return;
						}
					},
					function(err) {
					}
				);
			});
		}
		
		function switchToRegionControl()
		{
			require(["dojo/_base/array", "dojo/request", "dijit/registry", "dojox/mobile/TransitionEvent"], 
				function(array, request, registry, TransitionEvent)
			{
				list = registry.byId("list_regioncontrol");
				array.forEach(list.getChildren(),
				function(child)
				{
					list.removeChild(child);
					child.destroy();
				});
				request("/admin/json", 
				{
					method:"POST",
					data: JSON.stringify(
					{ 
						"method":"regions.list",
						"sessionid":sessionid
					}),
					headers:
					{
						"Content-Type":"application/json"
					},
					handleAs:"json"
				}).then(
					function(regions_data) 
					{
						if(!regions_data.success)
						{
							new TransitionEvent(viewmain, {
								moveTo: "#viewlogin",
								transition: "slide",
								transitionDir: -1
							}).dispatch();
							return;
						}
						
						array.forEach(regions_data.regions, function(region)
						{
							var childWidget = new dojox.mobile.ListItem({
								id:"startstop_"+region.ID, 
								label:region.Name});
							list.addChild(childWidget);
							var val = region.IsOnline ? "on" : "off";
							var sw = new dojox.mobile.Switch({
								value:val});
							childWidget.addChild(sw);
							sw.on("stateChanged", function(val) { startStopRegion(region.ID, val);});
						});
						
						new TransitionEvent(viewmain, {
							moveTo: "#viewregioncontrol",
							transition: "slide",
							transitionDir: 1
						}).dispatch();
					},
					function(err) {
					}
				);
			});
		}
	</script>
	<div id="viewregioncontrol" data-dojo-type="dojox/mobile/View">
		<h1 data-dojo-type="dojox/mobile/Heading" data-dojo-props="back:'Back', moveTo:'viewmain', transition:'slide', transitionDir:'-1'">Region Start/Stop Control</h1>
		<ul id="list_regioncontrol" data-dojo-type="dojox/mobile/RoundRectList">
		</ul>
	</div>
	<script>
		function enableDisableLogins(regionid, value)
		{
			var method = value == "on" ? "region.login.enable" : "region.login.disable";
			
			require(["dojo/request"], function(request)
			{
				request("/admin/json", {
					method:"POST",
					data: JSON.stringify(
					{
						"method":method,
						"id":regionid,
						"sessionid":sessionid
					}),
					headers:
					{
						"Content-Type":"application/json"
					},
					handleAs:"json"
				}).then(
					function(regions_data) 
					{
						if(!regions_data.success)
						{
							if(regions_data.reason == 1)
							{
								new TransitionEvent(viewmain, {
									moveTo: "#viewlogin",
									transition: "slide",
									transitionDir: -1
								}).dispatch();
							}
							else
							{
								alert("Failed "+regions_data.reason);
							}
							return;
						}
					},
					function(err) {
					}
				);
			});
		}

		function switchToLoginControl()
		{
			require(["dojo/_base/array", "dojo/request", "dijit/registry", "dojox/mobile/TransitionEvent"], 
				function(array, request, registry, TransitionEvent)
			{
				list = registry.byId("list_logincontrol");
				array.forEach(list.getChildren(),
				function(child)
				{
					list.removeChild(child);
					child.destroy();
				});
				request("/admin/json", 
				{
					method:"POST",
					data: JSON.stringify(
					{ 
						"method":"regions.list",
						"sessionid":sessionid
					}),
					headers:
					{
						"Content-Type":"application/json"
					},
					handleAs:"json"
				}).then(
					function(regions_data) 
					{
						if(!regions_data.success)
						{
							if(regions_data.reason == 1)
							{
								new TransitionEvent(viewmain, {
									moveTo: "#viewlogin",
									transition: "slide",
									transitionDir: -1
								}).dispatch();
							}
							return;
						}
						
						array.forEach(regions_data.regions, function(region)
						{
							if(region.IsOnline)
							{
								var childWidget = new dojox.mobile.ListItem({
									id:"login_"+region.ID, 
									label:region.Name});
								list.addChild(childWidget);
								var val = region.IsLoginsEnabled ? "on" : "off";
								var sw = new dojox.mobile.Switch({
									value:val});
								childWidget.addChild(sw);
								sw.on("stateChanged", function(val) {enableDisableLogins(region.ID, val);});
							}
						});
						
						new TransitionEvent(viewmain, {
							moveTo: "#viewlogincontrol",
							transition: "slide",
							transitionDir: 1
						}).dispatch();
					},
					function(err) {
					}
				);
			});
		}
	</script>
	<div id="viewlogincontrol" data-dojo-type="dojox/mobile/View">
		<h1 data-dojo-type="dojox/mobile/Heading" data-dojo-props="back:'Back', moveTo:'viewmain', transition:'slide', transitionDir:'-1'">Login Control</h1>
		<ul id="list_logincontrol" data-dojo-type="dojox/mobile/RoundRectList">
		</ul>
	</div>
	<div id="viewconsole" data-dojo-type="dojox/mobile/View">
		<h1 data-dojo-type="dojox/mobile/Heading" data-dojo-props="back:'Back', moveTo:'viewmain', transition:'slide', transitionDir:'-1'">Sim Console</h1>
		<script>
		function send_command()
		{
			require(["dojo/request", "dijit/registry"], function(request, registry)
			{
				var command = registry.byId("command_input").value;
				request("/admin/json", 
				{
					method:"POST",
					data: JSON.stringify(
					{ 
						"command":command,
						"method":"console.command",
						"sessionid":sessionid
					}),
					headers:
					{
						"Content-Type":"application/json"
					},
				}).then(
					function(response) 
					{
						registry.byId("command_output").set('innerHTML', command + "\n" +response);
					},
					function(err) {
					}
				);
			});
		}
		</script>
		<input id="command_input" data-dojo-type="dojox/mobile/TextBox" style="width: 90%;"/>
		<button id="command_send" data-dojo-type="dojox/mobile/Button" onClick="send_command()">Send</button>
		<div id="command_output" data-dojo-type="dojox/mobile/Pane" style="width: 90%; height: 20em;">Empty</div>
	</div>
</body>
</html>